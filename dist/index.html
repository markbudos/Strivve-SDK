<!doctype html>
<html>
  <head>
    <title>Getting Started</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.0.0/crypto-js.js"></script>
    <script src="strivve-sdk.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  </head>
  <body>
    <form id="site_job">
      <div>
        <label for="merchant_hostname">Site:</label>
      </div>
      <div>
        <input type="text" id="merchant_hostname">
      </div>
      <div>
        <label for="username">Username:</label>
      </div>
      <div>
        <input type="email" id="username">
      </div>
      <div>
        <label for="password">Password:</label>
      </div>
      <div>
        <input type="password" id="password"></textarea>
      </div>
      <div>
        <input type="submit" id="submit"></textarea>
      </div>
    </form>
    <div id="site_job_message" style="display:none"></div>
    <script>

      function get_hash_key_values() {
        var hash = window.location.hash ? window.location.hash.substring(1) : "";
        return hash.split('&').reduce(function (result, item) {
          var parts = item.split('='); result[parts[0]] = decodeURIComponent(parts[1]); return result;
        }, {});
      }

      async function post_job(event) {
        event.preventDefault();
        form = document.querySelector("#site_job");
        form.style.display = "none";
        var username = event.srcElement.elements['username'].value;
        var password = event.srcElement.elements['password'].value;
        var site_name = event.srcElement.elements['merchant_hostname'].value;

        var app_name = "CardUpdatr Demo";
        var app_key = "oqLSC5V/R4w42crQT7x0HjcM5NnS2tiyTzWSxnOVZdU="
        var cardsavr_server = "https://api.localhost.cardsavr.io";
        //var app_key = "TGSEjt4TuK0j55TeF7x1cao88Bc1j8nyHeaBHueT5gQ=";
        //var cardsavr_server = "https://api.mbudos.cardsavr.io";

        result = get_hash_key_values();
        var session = new strivvesdk.CardsavrSession(cardsavr_server, app_key, app_name, result.username, null, result.grant);
        var user = await session.init();
        if (user.body) {
          var cardsavr_user = user.body.user;
          var [account, cards] = await Promise.all(
            [session.createAccount(
              {cardholder_id: cardsavr_user.id,
              username: username, 
              password: password, 
              site_hostname: site_name}, cardsavr_user.cardholder_safe_key ),
            session.getCards()]
          );
          if (account.body && cards.body.length == 1) {
            var params = {
              user_id: cardsavr_user.id,
              card_id: cards.body[0].id,
              account_id: account.body.id,
              site_hostname: site_name,
              billed_brand: "staging",
              requesting_brand: "staging",
              user_is_present: true
            };
            console.dir(params);
            var ret = await session.createSingleSiteJob(params, cardsavr_user.cardholder_safe_key);
            console.dir(ret);
          }
        }
      }
 
      window.onload = function() {
        var form = document.querySelector("#site_job");
        if(form.addEventListener){
          form.addEventListener("submit", post_job, false);  //Modern browsers      
        }
      }

      function laod_sites() {
        sites = axios.get('https://swch-site-images-mgmt.s3-us-west-2.amazonaws.com/branding/sites.json');
        return sites;
      }

    </script>
  </body>
</html>